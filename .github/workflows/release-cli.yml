name: Release Linux CLI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (vX.Y.Z) to upload assets to"
        required: false
        type: string
  workflow_call:
    inputs:
      tag:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-linux-cli:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs-on: ubuntu-24.04
          - name: linux-arm64
            runs-on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4

      - name: Runner info
        run: |
          set -euo pipefail
          uname -a
          uname -m

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev

      - name: Build incubar (release)
        working-directory: src-tauri
        run: cargo build --release --bin incubar

      - name: Package
        id: pkg
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          if [[ "${{ github.event_name }}" != "release" ]]; then
            TAG="${{ inputs.tag }}"
          fi
          if [[ -z "$TAG" ]]; then
            echo "Missing tag for release packaging." >&2
            exit 1
          fi

          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64) ARCH="x86_64" ;;
            aarch64|arm64) ARCH="aarch64" ;;
          esac

          BIN_DIR="$(pwd)/src-tauri/target/release"
          OUT_DIR="$(mktemp -d)"
          install -m 0755 "$BIN_DIR/incubar" "$OUT_DIR/IncuBarCLI"
          ln -s "IncuBarCLI" "$OUT_DIR/incubar"

          ASSET="IncuBarCLI-${TAG}-linux-${ARCH}.tar.gz"
          (cd "$OUT_DIR" && tar czf "$ASSET" IncuBarCLI incubar)
          sha256sum "$OUT_DIR/$ASSET" > "$OUT_DIR/$ASSET.sha256"

          echo "out_dir=$OUT_DIR" >> "$GITHUB_OUTPUT"
          echo "asset=$ASSET" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        if: github.event_name == 'release' || inputs.tag != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ "${{ github.event_name }}" != "release" ]]; then
            TAG="${{ inputs.tag }}"
          fi
          OUT_DIR="${{ steps.pkg.outputs.out_dir }}"
          ASSET="${{ steps.pkg.outputs.asset }}"
          gh release upload "$TAG" "$OUT_DIR/$ASSET" "$OUT_DIR/$ASSET.sha256" --clobber

      - name: Upload workflow artifact (manual runs)
        if: github.event_name == 'workflow_dispatch' && inputs.tag == ''
        uses: actions/upload-artifact@v4
        with:
          name: incubar-linux-cli-${{ matrix.name }}
          path: |
            ${{ steps.pkg.outputs.out_dir }}/${{ steps.pkg.outputs.asset }}
            ${{ steps.pkg.outputs.out_dir }}/${{ steps.pkg.outputs.asset }}.sha256
